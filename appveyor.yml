# See http://www.appveyor.com/docs/appveyor-yml for many more options

version: 1.1.{build}

skip_non_tags: true

skip_commits:
  message: /readme.*|doc.*/

only_commits:
  files:
    - $env:APPVEYOR_PROJECT_NAME/
    - $env:APPVEYOR_PROJECT_NAME.nuspec

image:
- Visual Studio 2017
- Visual Studio 2015
- Visual Studio 2013
- WMF 5
- Ubuntu

init:
- ps: |
    $PSVersionTable
    [System.Environment]::OSVersion

install:
- ps: |
    Install-Package -Name Pester -Force -Scope CurrentUser -SkipPublisherCheck -PackageManagementProvider PowerShellGet | Out-Null
    Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

build_script:
- ps: |
    $sep = if ( $isWindows ) { ';' } elseif ( $isLinux ) { ':' } else { throw }
    $ModulePath = $env:PSModulePath -split $sep | select-object -first 1
    $ModuleRoot = Join-Path $ModulePath $env:APPVEYOR_PROJECT_NAME
    Copy-Item $env:APPVEYOR_PROJECT_NAME $ModuleRoot -Recurse

test_script:
- ps: |
    $res = Invoke-Pester -OutputFormat NUnitXml -OutputFile TestsResults.xml -PassThru
    $dest = "https://ci.appveyor.com/api/testresults/nunit/$($env:APPVEYOR_JOB_ID)"
    (New-Object 'System.Net.WebClient').UploadFile($dest, (Resolve-Path TestsResults.xml))
    if ($res.FailedCount) { throw "$($res.FailedCount) tests failed."}
